angular.module("userApp",["appRoutes","authToken","authService","authInterceptor","ui-notification","bidCtrl","mainCtrl","userCtrl","userConfirmCtrl","userCreateCtrl","userEditCtrl","homeCtrl","auctionCtrl","auctionCreateCtrl","auctionEditCtrl","userFactory","auctionFactory","socketService"]).config(["$httpProvider","NotificationProvider",function(e,t){e.interceptors.push("AuthInterceptor"),t.setOptions({delay:4e3,startTop:70,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"right",positionY:"top",replaceMessage:!0})}]),angular.module("appRoutes",["ngRoute"]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/views/pages/home.html",controller:"HomeController",controllerAs:"home",access:{loginRequired:!0}}).when("/restricted",{templateUrl:"app/views/pages/restricted.html",controller:"HomeController",controllerAs:"home",access:{loginRequired:!1}}).when("/login",{templateUrl:"app/views/pages/login.html",controller:"MainController",controllerAs:"login",access:{loginRequired:!1}}).when("/bids/:auction_id",{templateUrl:"app/views/pages/bids/single.html",controller:"BidController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions",{templateUrl:"app/views/pages/auctions/all.html",controller:"AuctionController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions/create",{templateUrl:"app/views/pages/auctions/single.html",controller:"AuctionCreateController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions/:auction_id",{templateUrl:"app/views/pages/auctions/single.html",controller:"AuctionEditController",controllerAs:"auction",access:{loginRequired:!0}}).when("/users",{templateUrl:"app/views/pages/users/all.html",controller:"UserController",controllerAs:"user",access:{loginRequired:!0}}).when("/register",{templateUrl:"/app/views/pages/users/register.html",controller:"UserCreateController",controllerAs:"user",access:{loginRequired:!1}}).when("/registered",{templateUrl:"/app/views/pages/users/registered.html",controller:"UserConfirmController",controllerAs:"user",access:{loginRequired:!1}}).when("/users/:user_id",{templateUrl:"app/views/pages/users/edit.html",controller:"UserEditController",controllerAs:"user",access:{loginRequired:!0}}),t.html5Mode(!0)}]),function(){function e(e,t){function n(){o.processing=!0,e.create(o.auctionData).success(function(e){o.processing=!1,o.auctionData={},t.success(e.message)})}var o=this;o.type="create",o.saveAuction=n}e.$inject=["Auction","Notification"],angular.module("auctionCreateCtrl",["auctionFactory"]).controller("AuctionCreateController",e)}(),function(){function e(e,t){e.main.user.admin||(window.location.href="/restricted");var n=this;n.processing=!0,t.all().success(function(e){n.processing=!1,n.auctions=e,n.count=e.length})}angular.module("auctionCtrl",["auctionFactory"]).controller("AuctionController",e),e.$inject=["$scope","Auction"]}(),function(){function e(e,t,n){var o=this;o.type="edit",t.get(e.auction_id,{blocked:!0}).success(function(e){o.auctionData=e}),o.saveAuction=function(){o.processing=!0,t.update(e.auction_id,o.auctionData).success(function(e){o.processing=!1,n.success(e.message),o.auctionData.resetbids&&(o.auctionData.bids=[]),o.auctionData.resetbids=!1})}}angular.module("auctionEditCtrl",["auctionFactory"]).controller("AuctionEditController",e),e.$inject=["$routeParams","Auction","Notification"]}(),function(){function e(e,t,n,o,r,i,a,s,u){function c(e){v.processing=!0,i.bid(t.auction_id,e).success(function(t){return v.confirmBid=!1,v.confirmAutobid=!1,v.autobid="",v.processing=!1,t.message&&(t.result?u.success(t.message):u.error(t.message)),!!t.success&&(v.current_bid=t.auction.bid,e.autobid&&v.auctionData.autobids.push(e),a.emit("bid:send",t.auction),void d(!0))})}function l(){var e=v.auctionData.autobids.filter(function(e){return e.userid==v.user.userid}).sort(function(e,t){return t.value-e.value});if(e.length>0)return e[0].value}function d(t){v.mybid=parseInt(v.current_bid.value)+parseInt(v.bidIncrement),v.hasBids=void 0!==v.current_bid.userid,v.user.autobid=l(),v.hasBids?(v.highestBidValue=v.current_bid.value,v.currentBidder=v.current_bid.userid===v.user.userid,v.mybid?v.currentBidder?(v.buttonclass="btn-danger disabled",v.buttontext=r.trustAsHtml("You are currently the highest bidder"),t&&u.success("You are currently the highest bidder")):(v.buttonclass="btn-primary",v.buttontext=r.trustAsHtml("Place Bid<br />("+o("currency")(v.mybid,"£ ")+")<span>You can review before submitting</span>"),t&&u.error("You are not the highest bidder")):v.buttonclass="hide",m(),g(),h=e(g,1e3)):v.mybid?(v.buttonclass="btn-primary",v.buttontext=r.trustAsHtml("Place Bid<br />("+o("currency")(v.mybid,"£ ")+")<span>You can review before submitting</span>")):v.buttonclass="hide"}function f(t){var n=moment(new Date(v.current_bid.created_at)),o=n.add(v.auctionData.countdown,"minutes"),r=moment.duration(o.diff(t));r<=0?(v.expired=!0,e.cancel(h)):p(r)}function p(e){v.timer={days:e._data.days,hours:e._data.hours,minutes:e._data.minutes,seconds:e._data.seconds}}function g(){var e=moment(new Date),t=moment(new Date(v.auctionData.end_date)),o=moment.duration(t.diff(e));p(o),w++>=C&&n.location.reload(),o<=0&&f(e)}function m(){e.cancel(h)}var h,b,v=this,C=60,w=0;s.getUser().then(function(e){v.user=e.data}),v.processing=!0,v.current_bid=v.current_bid||{},i.get(t.auction_id).success(function(e){v.auctionData=e,v.processing=!1,e.bids.length?v.current_bid=e.bids[e.bids.length-1]:(v.starting_bid=e.start_amount,v.current_bid.value=e.start_amount),y.startCountdown(),d()}),v.checkBid=function(){v.confirmBid=!0},v.cancelBid=function(){v.confirmBid=!1},v.saveBid=function(){c({value:v.mybid,userid:v.user.userid,username:v.user.username})},v.checkAutobid=function(){v.autobid>0?v.confirmAutobid=!0:v.autobid.focus()},v.cancelAutobid=function(){v.confirmAutobid=!1},v.saveAutobid=function(){c({value:v.autobid,userid:v.user.userid,username:v.user.username,autobid:!0})},v.selectBidIncrement=function(){d()},a.on("bid:reset",function(){n.location.reload()}),a.on("bid:send",function(e){var n=e.auction_id===t.auction_id;n&&(w=0,v.confirmBid=!1,v.current_bid=e.bid,d(!0))});var y={startCountdown:function(){y.stopCounter(),y.updateCounter(),y.startCountdown=e(y.startCountdown,1e3)},stopCounter:function(){e.cancel(b)},updateCounter:function(){var t=moment(new Date),n=moment(new Date(v.auctionData.start_date)),o=moment.duration(n.diff(t));o<=0?(v.active=!0,e.cancel(b)):v.start={days:o._data.days,hours:o._data.hours,minutes:o._data.minutes,seconds:o._data.seconds}}}}angular.module("bidCtrl",["auctionFactory","socketService"]).controller("BidController",e),e.$inject=["$interval","$routeParams","$window","$filter","$sce","Auction","Socket","Auth","Notification"]}(),function(){function e(e){function t(e){var t=moment(new Date),n=moment(new Date(e.start_date)),o=moment.duration(t.diff(n))>=0;if(!o)return{notstarted:!0};var r=moment(new Date(e.end_date)),i=moment.duration(t.diff(r))>=0;if(i&&e.bids.length>0){e.bids.sort(function(e,t){return t.value-e.value});var a=e.bids[0],s=moment(new Date(a.created_at)),u=s.add(e.countdown,"minutes"),c=moment.duration(u.diff(t));return c>=0?{live:!0}:{expired:!0,date:a.created_at}}return{live:!0}}var n=this;n.processing=!0,e.all().success(function(e){n.processing=!1,e.forEach(function(e){e.status=t(e)}),n.auctions=e})}e.$inject=["Auction"],angular.module("homeCtrl",["auctionFactory"]).controller("HomeController",e)}(),function(){function e(e,t,n,o){function r(e,t){u.loggedIn=o.isLoggedIn(e,t),o.getUser().then(function(e){u.user=e.data})}function i(){t.reload()}function a(){u.processing=!0,u.error="",o.login(u.loginData.username,u.loginData.password).success(function(e){u.processing=!1,e.success?n.path("/"):u.error=e.message})}function s(){o.logout(),u.user={},n.path("/login")}var u=this;u.loggedIn=o.isLoggedIn(),u.doLogin=a,u.doLogout=s,e.reloadRoute=i,e.$on("$routeChangeStart",r)}angular.module("mainCtrl",["ui.bootstrap.datetimepicker"]).controller("MainController",e),e.$inject=["$rootScope","$route","$location","Auth"]}(),function(){function e(){}angular.module("userConfirmCtrl",[]).controller("UserConfirmController",e)}(),function(){function e(e,t,n){var o=this;o.saveUser=function(){o.processing=!0,t.create(o.userData).success(function(t){o.processing=!1,n.success(t.message),t.success&&(o.userData={},e.path("/registered"))})}}angular.module("userCreateCtrl",["userFactory"]).controller("UserCreateController",e),e.$inject=["$location","User","Notification"]}(),function(){function e(e){var t=this;t.processing=!0,e.all().success(function(e){t.processing=!1,t.users=e,t.count=e.length}),t.deleteUser=function(n){t.processing=!0,e["delete"](n).success(function(n){e.all().success(function(e){t.processing=!1,t.users=e})})}}angular.module("userCtrl",["userFactory"]).controller("UserController",e),e.$inject=["User"]}(),function(){function e(e,t,n,o,r,i){function a(e){e&&(s.userImage=e)}var s=this;s.type="edit",n.get(e.user_id).success(function(e){s.userData=e,a(e.image)}),s.upload=function(e){if(s.progress=0,e&&e.length)for(var n=0;n<e.length;n++){var i=e[n];o.upload({url:"/api/users/"+s.userData._id+"/upload/",data:s.userData,method:"POST",file:i}).progress(function(e){var t=parseInt(100*e.loaded/e.total);s.progress=t,s.uploading=!0}).success(function(e,n,o,i){t(function(){r.success(e.message),a(e.filename),s.uploading=!1})})}},s.toggleBlock=function(t){s.processing=!0;var o={};o.blocked=t,o.pobox=s.userData.pobox,o.address=s.userData.address,o.city=s.userData.city,o.mobile=s.userData.mobile,n.update(e.user_id,o).success(function(e){s.processing=!1,o.blocked?(r.success("User has been blocked"),i.emit("bid:reset")):r.success("User has been Unblocked"),s.userData.blocked=o.blocked})},s.saveUser=function(){s.processing=!0,s.userData.removeImage&&(s.userData.image=""),n.update(e.user_id,s.userData).success(function(e){s.processing=!1,r.success(e.message)})}}angular.module("userEditCtrl",["userFactory","ngFileUpload"]).controller("UserEditController",e),e.$inject=["$routeParams","$timeout","User","Upload","Notification","Socket"]}(),function(){function e(e){function t(t,n){return e.get("/api/auctions/"+t,{params:n})}function n(){return e.get("/api/auctions")}function o(t){return e.post("/api/auctions",t)}function r(t,n){return e.put("/api/auctions/"+t,n)}function i(t,n){return e.put("/api/auctions/"+t+"/bid",n)}function a(t){return e["delete"]("/api/auctions/"+t)}return{get:t,all:n,create:o,update:r,bid:i,"delete":a}}angular.module("auctionFactory",[]).factory("Auction",e),e.$inject=["$http"]}(),function(){function e(e,t){function n(e){var n=t.getToken();return n&&(e.headers["x-access-token"]=n),e}function o(n){return 403==n.status&&("Restricted access"===n.data.message&&(window.location.href="/restricted"),t.setToken(),window.location.href="/login"),e.reject(n)}return{request:n,responseError:o}}angular.module("authInterceptor",["authToken"]).factory("AuthInterceptor",e),e.$inject=["$q","AuthToken"]}(),function(){function e(e,t,n,o){function r(t,n){return e.post("/api/authenticate",{username:t,password:n}).success(function(e){return o.setToken(e.token),e})}function i(){o.setToken()}function a(e,t){if(t=t||{},void 0!==t.access&&t.access.loginRequired)return!!o.getToken()||(n.path("/login"),!1)}function s(){return o.getToken()?e.get("/api/me",{cache:!0}):t.reject({message:"User has no token."})}return{login:r,logout:i,isLoggedIn:a,getUser:s}}angular.module("authService",["authToken"]).factory("Auth",e),e.$inject=["$http","$q","$location","AuthToken"]}(),function(){function e(e){function t(){return e.localStorage.getItem("token")}function n(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")}return{getToken:t,setToken:n}}angular.module("authToken",[]).factory("AuthToken",e),e.$inject=["$window"]}(),function(){function e(e){var t=io.connect();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,r){t.emit(n,o,function(){var n=arguments;e.$apply(function(){r&&r.apply(t,n)})})}}}angular.module("socketService",[]).factory("Socket",e),e.$inject=["$rootScope"]}(),function(){function e(e){function t(t){return e.get("/api/users/"+t)}function n(){return e.get("/api/users")}function o(t){return e.post("/api/users",t)}function r(t,n){return e.put("/api/users/"+t,n)}function i(t){return e["delete"]("/api/users/"+t)}return{get:t,all:n,create:o,update:r,"delete":i}}angular.module("userFactory",[]).factory("User",e),e.$inject=["$http"]}();