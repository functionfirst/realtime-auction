angular.module("userApp",["ngAnimate","appRoutes","authService","ui-notification","bidCtrl","mainCtrl","userCtrl","homeCtrl","auctionCtrl","userService","auctionService","socketService"]).config(["$httpProvider","NotificationProvider",function(e,t){e.interceptors.push("AuthInterceptor"),t.setOptions({delay:4e3,startTop:70,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"right",positionY:"top",replaceMessage:!0})}]),angular.module("appRoutes",["ngRoute"]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/views/pages/home.html",controller:"HomeController",controllerAs:"home",access:{loginRequired:!0}}).when("/restricted",{templateUrl:"app/views/pages/restricted.html",controller:"HomeController",controllerAs:"home",access:{loginRequired:!1}}).when("/login",{templateUrl:"app/views/pages/login.html",controller:"MainController",controllerAs:"login",access:{loginRequired:!1}}).when("/bids/:auction_id",{templateUrl:"app/views/pages/bids/single.html",controller:"BidController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions",{templateUrl:"app/views/pages/auctions/all.html",controller:"AuctionController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions/create",{templateUrl:"app/views/pages/auctions/single.html",controller:"AuctionCreateController",controllerAs:"auction",access:{loginRequired:!0}}).when("/auctions/:auction_id",{templateUrl:"app/views/pages/auctions/single.html",controller:"AuctionEditController",controllerAs:"auction",access:{loginRequired:!0}}).when("/users",{templateUrl:"app/views/pages/users/all.html",controller:"UserController",controllerAs:"user",access:{loginRequired:!0}}).when("/register",{templateUrl:"/app/views/pages/users/register.html",controller:"UserCreateController",controllerAs:"user",access:{loginRequired:!1}}).when("/registered",{templateUrl:"/app/views/pages/users/registered.html",controller:"UserConfirmController",controllerAs:"user",access:{loginRequired:!1}}).when("/users/:user_id",{templateUrl:"app/views/pages/users/edit.html",controller:"UserEditController",controllerAs:"user",access:{loginRequired:!0}}),t.html5Mode(!0)}]),angular.module("auctionCtrl",["auctionService"]).controller("AuctionController",["$scope","Auction",function(e,t){e.main.user.admin||(window.location.href="/restricted");var n=this;n.processing=!0,t.all().success(function(e){n.processing=!1,n.auctions=e,n.count=e.length})}]).controller("AuctionCreateController",["Auction","Notification",function(e,t){var n=this;n.type="create",n.saveAuction=function(){n.processing=!0,e.create(n.auctionData).success(function(e){n.processing=!1,n.auctionData={},t.success(e.message)})}}]).controller("AuctionEditController",["$routeParams","Auction","Notification",function(e,t,n){var o=this;o.type="edit",t.get(e.auction_id,{blocked:!0}).success(function(e){o.auctionData=e}),o.saveAuction=function(){o.processing=!0,t.update(e.auction_id,o.auctionData).success(function(e){o.processing=!1,n.success(e.message),o.auctionData.resetbids&&(o.auctionData.bids=[]),o.auctionData.resetbids=!1})}}]),angular.module("bidCtrl",["auctionService","socketService"]).controller("BidController",["$interval","$routeParams","$window","$filter","$sce","Auction","Socket","Auth","Notification",function(e,t,n,o,r,i,s,a,u){function c(e){v.processing=!0,i.bid(t.auction_id,e).success(function(t){return v.confirmBid=!1,v.confirmAutobid=!1,v.autobid="",v.processing=!1,t.message&&(t.result?u.success(t.message):u.error(t.message)),!!t.success&&(v.current_bid=t.auction.bid,e.autobid&&v.auctionData.autobids.push(e),s.emit("bid:send",t.auction),void d(!0))})}function l(){var e=v.auctionData.autobids.filter(function(e){return e.userid==v.user.userid}).sort(function(e,t){return t.value-e.value});if(e.length>0)return e[0].value}function d(t){v.mybid=parseInt(v.current_bid.value)+parseInt(v.bidIncrement),v.hasBids=void 0!==v.current_bid.userid,v.user.autobid=l(),v.hasBids?(v.highestBidValue=v.current_bid.value,v.currentBidder=v.current_bid.userid===v.user.userid,v.mybid?v.currentBidder?(v.buttonclass="btn-danger disabled",v.buttontext=r.trustAsHtml("You are currently the highest bidder"),t&&u.success("You are currently the highest bidder")):(v.buttonclass="btn-primary",v.buttontext=r.trustAsHtml("Place Bid<br />("+o("currency")(v.mybid,"£ ")+")<span>You can review before submitting</span>"),t&&u.error("You are not the highest bidder")):v.buttonclass="hide",m(),f(),h=e(f,1e3)):v.mybid?(v.buttonclass="btn-primary",v.buttontext=r.trustAsHtml("Place Bid<br />("+o("currency")(v.mybid,"£ ")+")<span>You can review before submitting</span>")):v.buttonclass="hide"}function p(t){var n=moment(new Date(v.current_bid.created_at)),o=n.add(v.auctionData.countdown,"minutes"),r=moment.duration(o.diff(t));r<=0?(v.expired=!0,e.cancel(h)):g(r)}function g(e){v.timer={days:e._data.days,hours:e._data.hours,minutes:e._data.minutes,seconds:e._data.seconds}}function f(){var e=moment(new Date),t=moment(new Date(v.auctionData.end_date)),o=moment.duration(t.diff(e));g(o),C++>=w&&n.location.reload(),o<=0&&p(e)}function m(){e.cancel(h)}var h,b,v=this,w=60,C=0;a.getUser().then(function(e){v.user=e.data}),v.processing=!0,v.current_bid=v.current_bid||{},i.get(t.auction_id).success(function(e){v.auctionData=e,v.processing=!1,e.bids.length?v.current_bid=e.bids[e.bids.length-1]:(v.starting_bid=e.start_amount,v.current_bid.value=e.start_amount),A.startCountdown(),d()}),v.checkBid=function(){v.confirmBid=!0},v.cancelBid=function(){v.confirmBid=!1},v.saveBid=function(){c({value:v.mybid,userid:v.user.userid,username:v.user.username})},v.checkAutobid=function(){v.autobid>0?v.confirmAutobid=!0:v.autobid.focus()},v.cancelAutobid=function(){v.confirmAutobid=!1},v.saveAutobid=function(){c({value:v.autobid,userid:v.user.userid,username:v.user.username,autobid:!0})},v.selectBidIncrement=function(){d()},s.on("bid:reset",function(){n.location.reload()}),s.on("bid:send",function(e){var n=e.auction_id===t.auction_id;n&&(C=0,v.confirmBid=!1,v.current_bid=e.bid,d(!0))});var A={startCountdown:function(){A.stopCounter(),A.updateCounter(),A.startCountdown=e(A.startCountdown,1e3)},stopCounter:function(){e.cancel(b)},updateCounter:function(){var t=moment(new Date),n=moment(new Date(v.auctionData.start_date)),o=moment.duration(n.diff(t));o<=0?(v.active=!0,e.cancel(b)):v.start={days:o._data.days,hours:o._data.hours,minutes:o._data.minutes,seconds:o._data.seconds}}}}]),angular.module("homeCtrl",["auctionService"]).controller("HomeController",["Auction",function(e){function t(e){var t=moment(new Date),n=moment(new Date(e.start_date)),o=moment.duration(t.diff(n))>=0;if(!o)return{notstarted:!0};var r=moment(new Date(e.end_date)),i=moment.duration(t.diff(r))>=0;if(i&&e.bids.length>0){e.bids.sort(function(e,t){return t.value-e.value});var s=e.bids[0],a=moment(new Date(s.created_at)),u=a.add(e.countdown,"minutes"),c=moment.duration(u.diff(t));return c>=0?{live:!0}:{expired:!0,date:s.created_at}}return{live:!0}}var n=this;n.processing=!0,e.all().success(function(e){n.processing=!1,e.forEach(function(e){e.status=t(e)}),n.auctions=e})}]),angular.module("mainCtrl",["ui.bootstrap.datetimepicker"]).controller("MainController",["$rootScope","$route","$location","Auth",function(e,t,n,o){var r=this;r.loggedIn=o.isLoggedIn(),e.$on("$routeChangeStart",function(e,t){r.loggedIn=o.isLoggedIn(e,t),o.getUser().then(function(e){r.user=e.data})}),e.reloadRoute=function(){t.reload()},r.doLogin=function(){r.processing=!0,r.error="",o.login(r.loginData.username,r.loginData.password).success(function(e){r.processing=!1,e.success?n.path("/"):r.error=e.message})},r.doLogout=function(){o.logout(),r.user={},n.path("/login")}}]),angular.module("userCtrl",["userService","ngFileUpload"]).controller("UserController",["User",function(e){var t=this;t.processing=!0,e.all().success(function(e){t.processing=!1,t.users=e,t.count=e.length}),t.deleteUser=function(n){t.processing=!0,e["delete"](n).success(function(n){e.all().success(function(e){t.processing=!1,t.users=e})})}}]).controller("UserCreateController",["$location","User","Notification",function(e,t,n){var o=this;o.saveUser=function(){o.processing=!0,t.create(o.userData).success(function(t){o.processing=!1,n.success(t.message),t.success&&(o.userData={},e.path("/registered"))})}}]).controller("UserConfirmController",function(){}).controller("UserEditController",["$routeParams","$timeout","User","Upload","Notification","Socket",function(e,t,n,o,r,i){function s(e){e&&(a.userImage=e)}var a=this;a.type="edit",n.get(e.user_id).success(function(e){a.userData=e,s(e.image)}),a.upload=function(e){if(a.progress=0,e&&e.length)for(var n=0;n<e.length;n++){var i=e[n];o.upload({url:"/api/users/"+a.userData._id+"/upload/",data:a.userData,method:"POST",file:i}).progress(function(e){var t=parseInt(100*e.loaded/e.total);a.progress=t,a.uploading=!0}).success(function(e,n,o,i){t(function(){r.success(e.message),s(e.filename),a.uploading=!1})})}},a.toggleBlock=function(t){a.processing=!0;var o={};o.blocked=t,o.pobox=a.userData.pobox,o.address=a.userData.address,o.city=a.userData.city,o.mobile=a.userData.mobile,n.update(e.user_id,o).success(function(e){a.processing=!1,o.blocked?(r.success("User has been blocked"),i.emit("bid:reset")):r.success("User has been Unblocked"),a.userData.blocked=o.blocked})},a.saveUser=function(){a.processing=!0,a.userData.removeImage&&(a.userData.image=""),n.update(e.user_id,a.userData).success(function(e){a.processing=!1,r.success(e.message)})}}]),angular.module("auctionService",[]).factory("Auction",["$http",function(e){var t={};return t.get=function(t,n){return e.get("/api/auctions/"+t,{params:n})},t.all=function(){return e.get("/api/auctions")},t.create=function(t){return e.post("/api/auctions",t)},t.update=function(t,n){return e.put("/api/auctions/"+t,n)},t.bid=function(t,n){return e.put("/api/auctions/"+t+"/bid",n)},t["delete"]=function(t){return e["delete"]("/api/auctions/"+t)},t}]),angular.module("authService",[]).factory("Auth",["$http","$q","$location","AuthToken",function(e,t,n,o){var r={};return r.login=function(t,n){return e.post("/api/authenticate",{username:t,password:n}).success(function(e){return o.setToken(e.token),e})},r.logout=function(){o.setToken()},r.isLoggedIn=function(e,t){if(t=t||{},void 0!==t.access&&t.access.loginRequired)return!!o.getToken()||(n.path("/login"),!1)},r.getUser=function(){return o.getToken()?e.get("/api/me",{cache:!0}):t.reject({message:"User has no token."})},r}]).factory("AuthToken",["$window",function(e){var t={};return t.getToken=function(){return e.localStorage.getItem("token")},t.setToken=function(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")},t}]).factory("AuthInterceptor",["$q","AuthToken",function(e,t){var n={};return n.request=function(e){var n=t.getToken();return n&&(e.headers["x-access-token"]=n),e},n.responseError=function(n){return 403==n.status&&("Restricted access"===n.data.message&&(window.location.href="/restricted"),t.setToken(),window.location.href="/login"),e.reject(n)},n}]),angular.module("socketService",[]).factory("Socket",["$rootScope",function(e){var t=io.connect();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,r){t.emit(n,o,function(){var n=arguments;e.$apply(function(){r&&r.apply(t,n)})})}}}]),angular.module("userService",[]).factory("User",["$http",function(e){var t={};return t.get=function(t){return e.get("/api/users/"+t)},t.all=function(){return e.get("/api/users")},t.create=function(t){return e.post("/api/users",t)},t.update=function(t,n){return e.put("/api/users/"+t,n)},t["delete"]=function(t){return e["delete"]("/api/users/"+t)},t}]);